<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>desarrollo.views &mdash; sap 3.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="sap 3.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../index.html">
          <span>sap 3.0 documentation</span></a></h1>
        <h2 class="heading"><span>desarrollo.views</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for desarrollo.views</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pydot</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.http.response</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">administracion.models</span> <span class="kn">import</span> <span class="n">Proyecto</span><span class="p">,</span> <span class="n">Rol</span><span class="p">,</span> <span class="n">TipoAtributo</span>
<span class="kn">from</span> <span class="nn">desarrollo.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Fase</span><span class="p">,</span> <span class="n">TipoItem</span><span class="p">,</span> <span class="n">ValorAtributo</span><span class="p">,</span> <span class="n">VersionItem</span><span class="p">,</span> <span class="n">LineaBase</span><span class="p">,</span> <span class="n">SolicitudCambio</span>
<span class="kn">from</span> <span class="nn">desarrollo.forms</span> <span class="kn">import</span> <span class="n">CrearItemForm</span><span class="p">,</span> <span class="n">ModificarItemForm</span><span class="p">,</span> <span class="n">CrearTipoItemForm</span><span class="p">,</span> <span class="n">ModificarTipoItemForm</span><span class="p">,</span> <span class="n">CrearLineaBaseForm</span><span class="p">,</span> <span class="n">CrearSolicitudForm</span>
<span class="kn">from</span> <span class="nn">inicio.decorators</span> <span class="kn">import</span> <span class="n">permiso_requerido</span><span class="p">,</span> <span class="n">miembro_proyecto</span><span class="p">,</span> <span class="n">rol_fase_requerido</span><span class="p">,</span> <span class="n">miembro_comite</span><span class="p">,</span> <span class="n">solicitud_requerida</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="desarrollo_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.desarrollo_view">[docs]</a><span class="k">def</span> <span class="nf">desarrollo_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del modulo de desarrollo. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">                - El usuario debe estar logueado.</span>
<span class="sd">                </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de los proyectos puestos en marcha.</span>
<span class="sd">        Inicialmente, se verifican los permisos del usuario solicitante para restringir (si es necesario) </span>
<span class="sd">        los botones de accion sobre cada proyecto.</span>
<span class="sd">          </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">                - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">      </span>
<span class="sd">                - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calcular_costo</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_fases</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_solicitudes</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">permisos</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Calcular costo de proyecto&#39;</span><span class="p">:</span>
                <span class="n">calcular_costo</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar fases de proyecto&#39;</span><span class="p">:</span>
                <span class="n">gestionar_fases</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar solicitudes&#39;</span><span class="p">:</span>
                <span class="n">gestionar_solicitudes</span> <span class="o">=</span> <span class="bp">True</span>
                
            <span class="k">if</span> <span class="n">calcular_costo</span> <span class="ow">and</span> <span class="n">gestionar_fases</span> <span class="ow">and</span> <span class="n">gestionar_solicitudes</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">calcular_costo</span> <span class="ow">and</span> <span class="n">gestionar_fases</span> <span class="ow">and</span> <span class="n">gestionar_solicitudes</span><span class="p">:</span>
                <span class="k">break</span>
            
    <span class="n">proyectos</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;proyectos&#39;</span><span class="p">:</span> <span class="n">proyectos</span><span class="p">,</span> <span class="s">&#39;calcular_costo&#39;</span><span class="p">:</span><span class="n">calcular_costo</span><span class="p">,</span> <span class="s">&#39;gestionar_fases&#39;</span><span class="p">:</span><span class="n">gestionar_fases</span><span class="p">,</span> <span class="s">&#39;gestionar_solicitudes&#39;</span><span class="p">:</span><span class="n">gestionar_solicitudes</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/desarrollo.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Calcular costo de proyecto&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<div class="viewcode-block" id="calcular_costo_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.calcular_costo_view">[docs]</a><span class="k">def</span> <span class="nf">calcular_costo_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del calculo del costo total de un proyecto. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Calcular costo de proyecto.</span>
<span class="sd">            - Debe ser miembro del proyecto en cuestion.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario conocer el costo total del proyecto seleccionado, para lograr esto, se recorren </span>
<span class="sd">        todas las fases y todos los items, y se suman los costos individuales de cada item hasta terminar el ciclo de </span>
<span class="sd">        recorrido por las fases del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">    </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fases</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">fases_valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">items_valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">costo_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">fases</span><span class="p">:</span>
        <span class="n">fases_valido</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fases</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">items_valido</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">costo_total</span> <span class="o">=</span> <span class="n">costo_total</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">costo</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;fases_valido&#39;</span><span class="p">:</span><span class="n">fases_valido</span><span class="p">,</span> <span class="s">&#39;items_valido&#39;</span><span class="p">:</span><span class="n">items_valido</span><span class="p">,</span> <span class="s">&#39;costo_total&#39;</span><span class="p">:</span><span class="n">costo_total</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/costo_total.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar solicitudes&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@miembro_comite</span><span class="p">()</span>
<div class="viewcode-block" id="solicitudes_proyecto_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.solicitudes_proyecto_view">[docs]</a><span class="k">def</span> <span class="nf">solicitudes_proyecto_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista de gestion de solicitudes de cambio. Se deben cumplir los siguientes requisitos para utilizar esta vista:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Gestionar solicitudes.</span>
<span class="sd">            - Debe ser miembro del proyecto en cuestion.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario (miembro del comite de cambios) gestionar todas las solicitudes de cambio del proyecto. </span>
<span class="sd">        Se cargan todas las solicitudes del proyecto y se envian como un listado al template de gestion de solicitudes</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">    </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">solicitudes</span> <span class="o">=</span> <span class="n">SolicitudCambio</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">proyecto</span><span class="o">=</span><span class="n">proyecto</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;solicitudes&#39;</span><span class="p">:</span><span class="n">solicitudes</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/gestion_solicitudes.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Analizar solicitud&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@miembro_comite</span><span class="p">()</span>
<div class="viewcode-block" id="analizar_solicitud_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.analizar_solicitud_view">[docs]</a><span class="k">def</span> <span class="nf">analizar_solicitud_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_solicitud</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para analizar una solicitud de cambio. Se deben cumplir los siguientes requisitos para utilizar esta vista:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Crear solicitud.</span>
<span class="sd">            - Debe ser miembro del proyecto en cuestion.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario visualizar todos los campos de una solicitud de cambio. Ademas, en el template generado por </span>
<span class="sd">        la vista, otorga los botones necesarios para votar la solicitud.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            - id_solicitud: el identificador de la solicitud de cambio.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">    </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">solicitud</span> <span class="o">=</span> <span class="n">SolicitudCambio</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">proyecto</span><span class="o">=</span><span class="n">proyecto</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_solicitud</span><span class="p">)</span>
    <span class="n">cant_votos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">eleccion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;eleccion&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span><span class="p">:</span>
            <span class="n">usuario_ya_voto</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">solicitud_concretada</span> <span class="o">=</span> <span class="bp">False</span>
            
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">:</span>
                <span class="n">usuario_ya_voto</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">solicitud_concretada</span> <span class="o">=</span> <span class="bp">True</span>
            
            <span class="k">if</span> <span class="n">usuario_ya_voto</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">solicitud_concretada</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">solicitud</span><span class="o">.</span><span class="n">votos</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votos</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">solicitud</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span> <span class="o">==</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">comite_de_cambios</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">item</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">linea_base</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Guardamos una version del item de la solicitud de cambio</span>
                        <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
                                                                  <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span>
                                                                  <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                                  <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                                  <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span> <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span>
                                                                  <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                            <span class="n">version_item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                        <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Obtenemos todos los items dependientes del item de la solicitud de cambio</span>
                        <span class="n">relaciones</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                        <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">nuevas_relaciones</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relaciones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relaciones</span><span class="p">:</span>
                                <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                        <span class="n">nuevas_relaciones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                            <span class="n">relaciones</span> <span class="o">=</span> <span class="n">nuevas_relaciones</span>
                        <span class="c"># Por cada item dependiente, cambiamos su estado a En revision. Ademas guardamos, por cada uno, una version.  </span>
                        <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">resultados</span><span class="p">:</span>
                            <span class="n">rs</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">3</span>
                            <span class="n">rs</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">rs</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                    
                            <span class="n">version_rs</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                                    <span class="n">descripcion</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                                    <span class="n">costo_temporal</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                                    <span class="n">estado</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                                    <span class="n">adan</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span> <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> 
                                                                    <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                            <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                                <span class="n">version_rs</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                            <span class="n">version_rs</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Modificamos la linea base a quebrada, y luego, almacenamos las versiones actuales de los items que correspondian a la linea base cerrada.</span>
                        <span class="n">linea_base</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">linea_base</span>
                        <span class="n">linea_base</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                            <span class="n">linea_base</span><span class="o">.</span><span class="n">versiones_item</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">version_item</span><span class="p">)</span>
                        <span class="n">linea_base</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Creamos una nueva linea base (abierta) que contendra todos los items anteriores, excepto aquel </span>
                        <span class="c"># item correspondiente a la solicitud de cambio.</span>
                        <span class="n">linea_base_nueva</span> <span class="o">=</span> <span class="n">LineaBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">nombre</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                                    <span class="n">descripcion</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">num_secuencia</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">num_secuencia</span><span class="p">,</span> 
                                                                    <span class="n">fase</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">fase</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                            <span class="n">i</span><span class="o">.</span><span class="n">linea_base</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="n">i</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                            <span class="n">linea_base_nueva</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">linea_base_nueva</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">solicitud</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    
                <span class="n">cant_votos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;solicitud&#39;</span><span class="p">:</span><span class="n">solicitud</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;usuario_ya_voto&#39;</span><span class="p">:</span><span class="n">usuario_ya_voto</span><span class="p">,</span> <span class="s">&#39;solicitud_concretada&#39;</span><span class="p">:</span><span class="n">solicitud_concretada</span><span class="p">,</span> <span class="s">&#39;cant_votos&#39;</span><span class="p">:</span><span class="n">cant_votos</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/analizar_solicitud.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cant_votos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;solicitud&#39;</span><span class="p">:</span><span class="n">solicitud</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;usuario_ya_voto&#39;</span><span class="p">:</span><span class="n">usuario_ya_voto</span><span class="p">,</span> <span class="s">&#39;solicitud_concretada&#39;</span><span class="p">:</span><span class="n">solicitud_concretada</span><span class="p">,</span> <span class="s">&#39;cant_votos&#39;</span><span class="p">:</span><span class="n">cant_votos</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/analizar_solicitud.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">usuario_ya_voto</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">solicitud_concretada</span> <span class="o">=</span> <span class="bp">False</span>
            
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">:</span>
                <span class="n">usuario_ya_voto</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">solicitud_concretada</span> <span class="o">=</span> <span class="bp">True</span>
            
            <span class="k">if</span> <span class="n">usuario_ya_voto</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">solicitud_concretada</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">solicitud</span><span class="o">.</span><span class="n">votos</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votos</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">solicitud</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span> <span class="o">==</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">comite_de_cambios</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">votos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">item</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">linea_base</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Guardamos una version del item de la solicitud de cambio</span>
                        <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
                                                                  <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span>
                                                                  <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                                  <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                                  <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span> <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span>
                                                                  <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                            <span class="n">version_item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                        <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Obtenemos todos los items dependientes del item de la solicitud de cambio</span>
                        <span class="n">relaciones</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                        <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">nuevas_relaciones</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relaciones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relaciones</span><span class="p">:</span>
                                <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                        <span class="n">nuevas_relaciones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                            <span class="n">relaciones</span> <span class="o">=</span> <span class="n">nuevas_relaciones</span>
                        <span class="c"># Por cada item dependiente, cambiamos su estado a En revision. Ademas guardamos, por cada uno, una version.  </span>
                        <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">resultados</span><span class="p">:</span>
                            <span class="n">rs</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">3</span>
                            <span class="n">rs</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">rs</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                    
                            <span class="n">version_rs</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                                    <span class="n">descripcion</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                                    <span class="n">costo_temporal</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                                    <span class="n">estado</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                                    <span class="n">adan</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span> <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> 
                                                                    <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                            <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                                <span class="n">version_rs</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                            <span class="n">version_rs</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Modificamos la linea base a quebrada, y luego, almacenamos las versiones actuales de los items que correspondian a la linea base cerrada.</span>
                        <span class="n">linea_base</span> <span class="o">=</span> <span class="n">solicitud</span><span class="o">.</span><span class="n">linea_base</span>
                        <span class="n">linea_base</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                            <span class="n">linea_base</span><span class="o">.</span><span class="n">versiones_item</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">version_item</span><span class="p">)</span>
                        <span class="n">linea_base</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
                        <span class="c"># Creamos una nueva linea base (abierta) que contendra todos los items anteriores, excepto aquel </span>
                        <span class="c"># item correspondiente a la solicitud de cambio.</span>
                        <span class="n">linea_base_nueva</span> <span class="o">=</span> <span class="n">LineaBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">nombre</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                                    <span class="n">descripcion</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">num_secuencia</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">num_secuencia</span><span class="p">,</span> 
                                                                    <span class="n">fase</span><span class="o">=</span><span class="n">linea_base</span><span class="o">.</span><span class="n">fase</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                            <span class="n">i</span><span class="o">.</span><span class="n">linea_base</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="n">i</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                            <span class="n">linea_base_nueva</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">linea_base_nueva</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">solicitud</span><span class="o">.</span><span class="n">aprobada</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">solicitud</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    
                <span class="n">cant_votos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;solicitud&#39;</span><span class="p">:</span><span class="n">solicitud</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;usuario_ya_voto&#39;</span><span class="p">:</span><span class="n">usuario_ya_voto</span><span class="p">,</span> <span class="s">&#39;solicitud_concretada&#39;</span><span class="p">:</span><span class="n">solicitud_concretada</span><span class="p">,</span> <span class="s">&#39;cant_votos&#39;</span><span class="p">:</span><span class="n">cant_votos</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/analizar_solicitud.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cant_votos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;solicitud&#39;</span><span class="p">:</span><span class="n">solicitud</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;usuario_ya_voto&#39;</span><span class="p">:</span><span class="n">usuario_ya_voto</span><span class="p">,</span> <span class="s">&#39;solicitud_concretada&#39;</span><span class="p">:</span><span class="n">solicitud_concretada</span><span class="p">,</span> <span class="s">&#39;cant_votos&#39;</span><span class="p">:</span><span class="n">cant_votos</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/analizar_solicitud.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cant_votos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">solicitud</span><span class="o">.</span><span class="n">votantes</span><span class="p">)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;solicitud&#39;</span><span class="p">:</span><span class="n">solicitud</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;cant_votos&#39;</span><span class="p">:</span><span class="n">cant_votos</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/analizar_solicitud.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Crear solicitud&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<div class="viewcode-block" id="crear_solicitud_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.crear_solicitud_view">[docs]</a><span class="k">def</span> <span class="nf">crear_solicitud_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista de creacion de una solicitud de cambio. Se deben cumplir los siguientes requisitos para utilizar esta vista:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Crear solicitud.</span>
<span class="sd">            - Debe ser miembro del proyecto en cuestion.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario crear una solicitud de cambio para alterar un item bloqueado de una fase en curso.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_linea_base: el identificador de la linea base.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">    </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">existe_lb</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">linea_base</span><span class="p">:</span>
        <span class="n">existe_lb</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="n">form</span> <span class="o">=</span> <span class="n">CrearSolicitudForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CrearSolicitudForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">descripcion</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;descripcion&#39;</span><span class="p">]</span>
            <span class="n">accion</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;accion&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">accion</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">accion</span> <span class="o">=</span> <span class="s">&quot;Modificar item&quot;</span>
            <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s">&quot;2&quot;</span><span class="p">:</span>
                <span class="n">accion</span> <span class="o">=</span> <span class="s">&quot;Eliminar item&quot;</span>
            <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s">&quot;3&quot;</span><span class="p">:</span>
                <span class="n">accion</span> <span class="o">=</span> <span class="s">&quot;Agregar relacion a item&quot;</span>
            <span class="k">elif</span> <span class="n">accion</span> <span class="o">==</span> <span class="s">&quot;4&quot;</span><span class="p">:</span>
                <span class="n">accion</span> <span class="o">=</span> <span class="s">&quot;Quitar relacion de item&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">accion</span> <span class="o">=</span> <span class="s">&quot;Reversionar item&quot;</span>
            
            <span class="c"># Borramos cualquier solicitud del mismo item y con la misma accion (si es que existe).</span>
            <span class="n">solicitudes_item</span> <span class="o">=</span> <span class="n">SolicitudCambio</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">solicitudes_item</span><span class="p">:</span>
                <span class="n">existe_solicitud</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">solicitud</span> <span class="o">=</span> <span class="n">solicitudes_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">accion</span><span class="o">=</span><span class="n">accion</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">SolicitudCambio</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="n">existe_solicitud</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">existe_solicitud</span><span class="p">:</span>
                    <span class="n">solicitud</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            
            <span class="n">solicitud</span> <span class="o">=</span> <span class="n">SolicitudCambio</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">proyecto</span><span class="o">=</span><span class="n">proyecto</span><span class="p">,</span> 
                                                       <span class="n">fase</span><span class="o">=</span><span class="n">fase</span><span class="p">,</span> <span class="n">linea_base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                                                       <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span> <span class="n">descripcion</span><span class="o">=</span><span class="n">descripcion</span><span class="p">,</span>
                                                       <span class="n">votantes</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">votos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">accion</span><span class="o">=</span><span class="n">accion</span><span class="p">,</span> 
                                                       <span class="n">fecha_emision</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">existe_lb</span><span class="p">:</span>
                <span class="n">solicitud</span><span class="o">.</span><span class="n">linea_base</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">linea_base</span>
            
            <span class="n">solicitud</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/items/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">existe_lb</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;linea_base&#39;</span><span class="p">:</span><span class="n">item</span><span class="o">.</span><span class="n">linea_base</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">}</span>
        
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/crear_solicitud.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar fases de proyecto&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<div class="viewcode-block" id="fases_proyecto_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.fases_proyecto_view">[docs]</a><span class="k">def</span> <span class="nf">fases_proyecto_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de fases por proyecto. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">                - El usuario debe estar logueado.</span>
<span class="sd">                - El usuario debe poseer el permiso: Gestionar fases de proyecto.</span>
<span class="sd">                - Debe ser miembro del proyecto en cuestion.</span>
<span class="sd">        </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de las fases por proyecto.</span>
<span class="sd">        Inicialmente, se verifican los permisos del usuario solicitante para restringir (si es necesario) </span>
<span class="sd">        los botones de accion sobre cada fase.</span>
<span class="sd">                </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">                - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">                - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">                - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">gestionar_tipos_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_lineas_base</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_items</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_roles</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">iniciar_fase</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">finalizar_fase</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">permisos</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar tipos de item de fase&#39;</span><span class="p">:</span>
                <span class="n">gestionar_tipos_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar roles de fase&#39;</span><span class="p">:</span>
                <span class="n">gestionar_roles</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Iniciar fase&#39;</span><span class="p">:</span>
                <span class="n">iniciar_fase</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Finalizar fase&#39;</span><span class="p">:</span>
                <span class="n">finalizar_fase</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar items de fase&#39;</span><span class="p">:</span>
                <span class="n">gestionar_items</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar lineas base de fase&#39;</span><span class="p">:</span>
                <span class="n">gestionar_lineas_base</span> <span class="o">=</span> <span class="bp">True</span>
                
            <span class="k">if</span> <span class="n">gestionar_tipos_item</span> <span class="ow">and</span> <span class="n">gestionar_roles</span> <span class="ow">and</span> <span class="n">iniciar_fase</span> <span class="ow">and</span> <span class="n">finalizar_fase</span> <span class="ow">and</span> <span class="n">gestionar_items</span> <span class="ow">and</span> <span class="n">gestionar_lineas_base</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">gestionar_tipos_item</span> <span class="ow">and</span> <span class="n">gestionar_roles</span> <span class="ow">and</span> <span class="n">iniciar_fase</span> <span class="ow">and</span> <span class="n">finalizar_fase</span> <span class="ow">and</span> <span class="n">gestionar_items</span> <span class="ow">and</span> <span class="n">gestionar_lineas_base</span><span class="p">:</span>
                <span class="k">break</span>
            
    <span class="n">fases</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">grafo_proyecto</span> <span class="o">=</span> <span class="n">pydot</span><span class="o">.</span><span class="n">Dot</span><span class="p">(</span><span class="n">graph_type</span><span class="o">=</span><span class="s">&#39;digraph&#39;</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s">&quot;Verdana&quot;</span><span class="p">,</span> <span class="n">rankdir</span><span class="o">=</span><span class="s">&quot;TB&quot;</span><span class="p">)</span>
    <span class="n">grafo_proyecto</span><span class="o">.</span><span class="n">set_node_defaults</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s">&quot;filled&quot;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s">&quot;record&quot;</span><span class="p">)</span>
    <span class="n">grafo_proyecto</span><span class="o">.</span><span class="n">set_edge_defaults</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span> <span class="n">arrowhead</span><span class="o">=</span><span class="s">&quot;vee&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fases</span><span class="p">:</span>
        <span class="n">cluster_fase</span> <span class="o">=</span> <span class="n">pydot</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span><span class="s">&quot;fase&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                                     <span class="n">label</span><span class="o">=</span><span class="s">&quot;Fase: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">nombre</span><span class="p">),</span> 
                                     <span class="n">shape</span><span class="o">=</span><span class="s">&#39;rectangle&#39;</span><span class="p">,</span> 
                                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                                     <span class="n">style</span><span class="o">=</span><span class="s">&#39;filled&#39;</span><span class="p">,</span> 
                                     <span class="n">color</span><span class="o">=</span><span class="s">&#39;#E6E6E6&#39;</span><span class="p">,</span> 
                                     <span class="n">fillcolor</span><span class="o">=</span><span class="s">&quot;#BDBDBD&quot;</span><span class="p">,</span> 
                                     <span class="n">fontcolor</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">linea_base</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">color_estado</span> <span class="o">=</span> <span class="s">&quot;white&quot;</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">color_estado</span> <span class="o">=</span> <span class="s">&quot;#80FF00&quot;</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">color_estado</span> <span class="o">=</span> <span class="s">&quot;#045FB4&quot;</span>
                
                <span class="n">cluster_fase</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">pydot</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                                      <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;&lt;f0&gt;Item: </span><span class="si">%s</span><span class="s">|&lt;f1&gt;Costo: </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">),</span>
                                      <span class="n">fillcolor</span><span class="o">=</span><span class="n">color_estado</span><span class="p">,</span> 
                                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">linea_base</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">lineas_base</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="n">lineas_base</span><span class="p">:</span>
                <span class="n">cluster_linea_base</span> <span class="o">=</span> <span class="n">pydot</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span><span class="s">&quot;lb&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> 
                                                   <span class="n">label</span><span class="o">=</span><span class="s">&quot;Linea base: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">nombre</span><span class="p">),</span> 
                                                   <span class="n">shape</span><span class="o">=</span><span class="s">&#39;rectangle&#39;</span><span class="p">,</span> 
                                                   <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                                                   <span class="n">style</span><span class="o">=</span><span class="s">&#39;filled&#39;</span><span class="p">,</span> 
                                                   <span class="n">color</span><span class="o">=</span><span class="s">&#39;#E6E6E6&#39;</span><span class="p">,</span> 
                                                   <span class="n">fillcolor</span><span class="o">=</span><span class="s">&quot;#FFFFFF&quot;</span><span class="p">,</span> 
                                                   <span class="n">fontcolor</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">color_estado</span> <span class="o">=</span> <span class="s">&quot;#80FF00&quot;</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">color_estado</span> <span class="o">=</span> <span class="s">&quot;#DF0101&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color_estado</span> <span class="o">=</span> <span class="s">&quot;#045FB4&quot;</span>
                    
                    <span class="n">cluster_linea_base</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">pydot</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> 
                                                           <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;&lt;f0&gt;Item: </span><span class="si">%s</span><span class="s">|&lt;f1&gt;Costo: </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">),</span> 
                                                           <span class="n">fillcolor</span><span class="o">=</span><span class="n">color_estado</span><span class="p">,</span> 
                                                           <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span>
                <span class="n">cluster_fase</span><span class="o">.</span><span class="n">add_subgraph</span><span class="p">(</span><span class="n">cluster_linea_base</span><span class="p">)</span>
            
        <span class="n">grafo_proyecto</span><span class="o">.</span><span class="n">add_subgraph</span><span class="p">(</span><span class="n">cluster_fase</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fases</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">relaciones</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relaciones</span><span class="p">:</span>
                <span class="n">grafo_proyecto</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">pydot</span><span class="o">.</span><span class="n">Edge</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;item&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> 
                                                   <span class="n">label</span><span class="o">=</span><span class="s">&#39;costo=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">),</span> 
                                                   <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
            
    <span class="n">ruta_grafo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;grafos/grafo_proyecto_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proyecto</span><span class="o">.</span><span class="n">nombre</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span>
    <span class="n">grafo_proyecto</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ruta_grafo</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="s">&#39;dot&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">ruta_grafo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;grafos/grafo_proyecto_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proyecto</span><span class="o">.</span><span class="n">nombre</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fases&#39;</span><span class="p">:</span><span class="n">fases</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;ruta_grafo&#39;</span><span class="p">:</span><span class="n">ruta_grafo</span><span class="p">,</span> <span class="s">&#39;gestionar_tipos_item&#39;</span><span class="p">:</span><span class="n">gestionar_tipos_item</span><span class="p">,</span> <span class="s">&#39;gestionar_roles&#39;</span><span class="p">:</span><span class="n">gestionar_roles</span><span class="p">,</span> <span class="s">&#39;iniciar_fase&#39;</span><span class="p">:</span><span class="n">iniciar_fase</span><span class="p">,</span> <span class="s">&#39;finalizar_fase&#39;</span><span class="p">:</span><span class="n">finalizar_fase</span><span class="p">,</span> <span class="s">&#39;gestionar_items&#39;</span><span class="p">:</span><span class="n">gestionar_items</span><span class="p">,</span> <span class="s">&#39;gestionar_lineas_base&#39;</span><span class="p">:</span><span class="n">gestionar_lineas_base</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;desarrollo/gestion_fases.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>    
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar roles de fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="roles_fase_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.roles_fase_view">[docs]</a><span class="k">def</span> <span class="nf">roles_fase_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de roles por fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Gestionar roles de fase.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de los roles de la fase previamente seleccionada.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">Rol</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fase__id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;roles&#39;</span><span class="p">:</span><span class="n">roles</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/roles_fase.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="fase_agregar_rol_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.fase_agregar_rol_view">[docs]</a><span class="k">def</span> <span class="nf">fase_agregar_rol_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de roles del proyecto ligado a la fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar todos los roles del proyecto al cual esta ligada la fase, ademas, el template relacionado concede </span>
<span class="sd">        las opciones para agregar un rol seleccionado.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;roles&#39;</span><span class="p">:</span><span class="n">roles</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/agregar_rol.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Agregar rol a fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="fase_confirmacion_agregar_rol_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.fase_confirmacion_agregar_rol_view">[docs]</a><span class="k">def</span> <span class="nf">fase_confirmacion_agregar_rol_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_rol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista de confirmacion de agregacion de un rol a una fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Agregar rol a fase.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario agregar un rol seleccionado a la fase seleccionada previamente. Se verifica si el rol a agregar ya </span>
<span class="sd">        pertenece a la fase, en cuyo caso se cancelara la operacion.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_rol: el identificador del rol.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">rol</span> <span class="o">=</span> <span class="n">Rol</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_rol</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">existe_rol</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_rol</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Rol</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">existe_rol</span> <span class="o">=</span> <span class="bp">False</span>
             
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">existe_rol</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rol</span><span class="p">)</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;rol&#39;</span><span class="p">:</span><span class="n">rol</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;existe_rol&#39;</span><span class="p">:</span><span class="n">existe_rol</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/confirmacion_agregar_rol.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>  
    </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Quitar rol de fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="fase_quitar_rol_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.fase_quitar_rol_view">[docs]</a><span class="k">def</span> <span class="nf">fase_quitar_rol_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_rol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para quitar un rol de una fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Quitar rol de fase.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">        </span>
<span class="sd">        Esta vista permite al usuario quitar un rol seleccionado de la fase seleccionada previamente.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_rol: el identificador del rol.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">rol</span> <span class="o">=</span> <span class="n">Rol</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_rol</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rol</span><span class="p">)</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;rol&#39;</span><span class="p">:</span><span class="n">rol</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/quitar_rol.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar tipos de item de fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="tipos_item_fase_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.tipos_item_fase_view">[docs]</a><span class="k">def</span> <span class="nf">tipos_item_fase_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de tipos de item del sistema. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">                - El usuario debe estar logueado.</span>
<span class="sd">                - El usuario debe poseer el permiso: Gestionar tipos de item de fase.</span>
<span class="sd">                - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">                </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de los tipos de item del sistema.</span>
<span class="sd">        Inicialmente, se verifican los permisos del usuario solicitante para restringir (si es necesario) </span>
<span class="sd">        los botones de accion sobre cada tipo de item.</span>
<span class="sd">                </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">                - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">                - id_fase: el identificador de la fase.</span>
<span class="sd">                - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">                - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">crear_tipo_de_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">modificar_tipo_de_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">eliminar_tipo_de_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">visualizar_tipo_de_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_tipos_de_atributo</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">permisos</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Crear tipo de item&#39;</span><span class="p">:</span>
                <span class="n">crear_tipo_de_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Modificar tipo de item&#39;</span><span class="p">:</span>
                <span class="n">modificar_tipo_de_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Eliminar tipo de item&#39;</span><span class="p">:</span>
                <span class="n">eliminar_tipo_de_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Visualizar tipo de item&#39;</span><span class="p">:</span>
                <span class="n">visualizar_tipo_de_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar tipos de atributo de tipo de item&#39;</span><span class="p">:</span>
                <span class="n">gestionar_tipos_de_atributo</span> <span class="o">=</span> <span class="bp">True</span>
                
            <span class="k">if</span> <span class="n">crear_tipo_de_item</span> <span class="ow">and</span> <span class="n">modificar_tipo_de_item</span> <span class="ow">and</span> <span class="n">eliminar_tipo_de_item</span> <span class="ow">and</span> <span class="n">visualizar_tipo_de_item</span> <span class="ow">and</span> <span class="n">gestionar_tipos_de_atributo</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">crear_tipo_de_item</span> <span class="ow">and</span> <span class="n">modificar_tipo_de_item</span> <span class="ow">and</span> <span class="n">eliminar_tipo_de_item</span> <span class="ow">and</span> <span class="n">visualizar_tipo_de_item</span> <span class="ow">and</span> <span class="n">gestionar_tipos_de_atributo</span><span class="p">:</span>
                <span class="k">break</span>
            
    <span class="n">tipos_item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">tipos_item</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tipos_item&#39;</span><span class="p">:</span><span class="n">tipos_item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;crear_tipo_de_item&#39;</span><span class="p">:</span><span class="n">crear_tipo_de_item</span><span class="p">,</span> <span class="s">&#39;modificar_tipo_de_item&#39;</span><span class="p">:</span><span class="n">modificar_tipo_de_item</span><span class="p">,</span> <span class="s">&#39;eliminar_tipo_de_item&#39;</span><span class="p">:</span><span class="n">eliminar_tipo_de_item</span><span class="p">,</span> <span class="s">&#39;visualizar_tipo_de_item&#39;</span><span class="p">:</span><span class="n">visualizar_tipo_de_item</span><span class="p">,</span> <span class="s">&#39;gestionar_tipos_de_atributo&#39;</span><span class="p">:</span><span class="n">gestionar_tipos_de_atributo</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/gestion_tipos_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
  </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Crear tipo de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="crear_tipo_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.crear_tipo_item_view">[docs]</a><span class="k">def</span> <span class="nf">crear_tipo_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para crear un tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Crear tipo de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario crear un tipo de item para lograr esto, se verifica la validez de cada campo ingresado y </span>
<span class="sd">        luego se crea el tipo de item de acuerdo a los campos ingresados. </span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: si la operacion resulto ser de tipo GET o el formulario resulto invalido, devuelve el contexto, </span>
<span class="sd">            generado en la vista, al template correspondiente.</span>
<span class="sd">            - HttpResponseRedirect: si la operacion resulto valida, se redirige al template del listado de usuarios. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">form</span> <span class="o">=</span> <span class="n">CrearTipoItemForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">CrearTipoItemForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">nombre</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;nombre&#39;</span><span class="p">]</span>
                <span class="n">descripcion</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;descripcion&#39;</span><span class="p">]</span>
                
                <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">nombre</span><span class="o">=</span><span class="n">nombre</span><span class="p">,</span> <span class="n">descripcion</span><span class="o">=</span><span class="n">descripcion</span><span class="p">)</span>
                <span class="n">tipo_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">fase</span><span class="o">.</span><span class="n">tipos_item</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tipo_item</span><span class="p">)</span>
                <span class="n">fase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/tipos_item/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/crear_tipo_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/crear_tipo_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Modificar tipo de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="modificar_tipo_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.modificar_tipo_item_view">[docs]</a><span class="k">def</span> <span class="nf">modificar_tipo_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_tipo_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para modificar un tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Modificar tipo de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario modificar un tipo de item previamente seleccionada, para lograr esto, </span>
<span class="sd">        se verifica la validez de cada campo modificado y luego se guarda el tipo de item de acuerdo a los campos ingresados.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_tipo_item: el identificador del tipo de item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: si la operacion resulto ser de tipo GET o el formulario resulto invalido, devuelve el contexto, </span>
<span class="sd">            generado en la vista, al template correspondiente.</span>
<span class="sd">            - HttpResponseRedirect: si la operacion resulto valida, se redirige al template de visualizacion de la fase modificada. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">tipos_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">ModificarTipoItemForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">nombre</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;nombre&#39;</span><span class="p">]</span>
                <span class="n">descripcion</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;descripcion&#39;</span><span class="p">]</span>
                
                <span class="n">tipo_item</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">nombre</span>
                <span class="n">tipo_item</span><span class="o">.</span><span class="n">descripcion</span> <span class="o">=</span> <span class="n">descripcion</span>
    
                <span class="n">tipo_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/tipos_item/tipo_item/</span><span class="si">%s</span><span class="s">/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tipo_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
            
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ModificarTipoItemForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;nombre&#39;</span><span class="p">:</span> <span class="n">tipo_item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
            <span class="s">&#39;descripcion&#39;</span><span class="p">:</span> <span class="n">tipo_item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span>
            <span class="p">})</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s">&#39;tipo_item&#39;</span><span class="p">:</span> <span class="n">tipo_item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/modificar_tipo_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
  </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Visualizar tipo de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="visualizar_tipo_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.visualizar_tipo_item_view">[docs]</a><span class="k">def</span> <span class="nf">visualizar_tipo_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_tipo_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para visualizar un tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Visualizar tipo de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario visualizar todos los campos guardados de un tipo de item previamente seleccionado.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_tipo_item: el identificador del tipo de item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">tipos_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tipo_item&#39;</span><span class="p">:</span> <span class="n">tipo_item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/visualizar_tipo_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Eliminar tipo de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="eliminar_tipo_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.eliminar_tipo_item_view">[docs]</a><span class="k">def</span> <span class="nf">eliminar_tipo_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_tipo_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para eliminar un tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Eliminar tipo de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario eliminar un tipo de item previamente seleccionado.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_tipo_item: el identificador del tipo de item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: si la operacion resulto ser de tipo GET o no se cumplieron las condiciones para eliminar, devuelve el contexto, </span>
<span class="sd">            generado en la vista, al template correspondiente.</span>
<span class="sd">            - HttpResponseRedirect: si la operacion resulto valida, se redirige al template del listado de fases. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">tipos_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">tipo_item</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/tipos_item/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tipo_item&#39;</span><span class="p">:</span><span class="n">tipo_item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/eliminar_tipo_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar tipos de atributo de tipo de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="tipos_atributo_tipo_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.tipos_atributo_tipo_item_view">[docs]</a><span class="k">def</span> <span class="nf">tipos_atributo_tipo_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_tipo_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de tipos de atributo del tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Gestionar tipos de atributo de tipo de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de los tipos de atributo del item previamente seleccionado.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_tipo_item: el identificador del tipo de item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">tipos_atributo</span> <span class="o">=</span> <span class="n">TipoAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tipoitem__id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tipo_item&#39;</span><span class="p">:</span><span class="n">tipo_item</span><span class="p">,</span> <span class="s">&#39;tipos_atributo&#39;</span><span class="p">:</span><span class="n">tipos_atributo</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/tipos_atributo_tipo_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="agregar_tipo_atributo_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.agregar_tipo_atributo_view">[docs]</a><span class="k">def</span> <span class="nf">agregar_tipo_atributo_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_tipo_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de tipos de atributo ligados al tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar todos los tipos de atributo del sistema, ademas, el template relacionado concede </span>
<span class="sd">        las opciones para agregar un tipo de atributo seleccionado.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_tipo_item: el identificador del tipo de item.</span>
<span class="sd">            - id_fase: el identificador del la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">tipos_atributo</span> <span class="o">=</span> <span class="n">TipoAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tipo_item&#39;</span><span class="p">:</span><span class="n">tipo_item</span><span class="p">,</span> <span class="s">&#39;tipos_atributo&#39;</span><span class="p">:</span><span class="n">tipos_atributo</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/agregar_tipo_atributo.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Agregar tipo de atributo a tipo de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="confirmacion_agregar_tipo_atributo_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.confirmacion_agregar_tipo_atributo_view">[docs]</a><span class="k">def</span> <span class="nf">confirmacion_agregar_tipo_atributo_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_tipo_atributo</span><span class="p">,</span> <span class="n">id_tipo_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista de confirmacion de agregacion de un tipo de atributo a un tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Agregar tipo de atributo a tipo de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario agregar un tipo de atributo seleccionado a el tipo de item seleccionado previamente. Se verifica si el tipo de atributo a agregar ya </span>
<span class="sd">        pertenece al tipo de item, en cuyo caso se cancelara la operacion.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_tipo_item: el identificador del tipo de item.</span>
<span class="sd">            - id_tipo_atributo: el identificador del tipo de atributo.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">tipo_atributo</span> <span class="o">=</span> <span class="n">TipoAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_atributo</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">existe_tipo_atributo</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tipo_atribut</span> <span class="o">=</span> <span class="n">tipo_item</span><span class="o">.</span><span class="n">tipos_atributo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_atributo</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TipoAtributo</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">existe_tipo_atributo</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">existe_tipo_atributo</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">tipo_item</span><span class="o">.</span><span class="n">tipos_atributo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tipo_atributo</span><span class="p">)</span>
        <span class="n">tipo_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tipo_item&#39;</span><span class="p">:</span><span class="n">tipo_item</span><span class="p">,</span> <span class="s">&#39;tipo_atributo&#39;</span><span class="p">:</span><span class="n">tipo_atributo</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;existe_tipo_atributo&#39;</span><span class="p">:</span><span class="n">existe_tipo_atributo</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/confirmacion_agregar_tipo_atributo.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Quitar tipo de atributo de tipo de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="quitar_tipo_atributo_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.quitar_tipo_atributo_view">[docs]</a><span class="k">def</span> <span class="nf">quitar_tipo_atributo_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_tipo_atributo</span><span class="p">,</span> <span class="n">id_tipo_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para quitar un tipo de atributo de un tipo de item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Quitar tipo de atributo de tipo de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">        </span>
<span class="sd">        Esta vista permite al usuario quitar un tipo de atributo seleccionado del tipo de item seleccionado previamente.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_tipo_item: el identificador de la tipo de item.</span>
<span class="sd">            - id_tipo_atributo: el identificador del tipo de atributo.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
    <span class="n">tipo_atributo</span> <span class="o">=</span> <span class="n">TipoAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_atributo</span><span class="p">)</span>
    <span class="n">atributos</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tipo_atributo__id</span><span class="o">=</span><span class="n">id_tipo_atributo</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">posee_atributos</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">atributos</span><span class="p">:</span>
        <span class="n">posee_atributos</span> <span class="o">=</span> <span class="bp">True</span>
        
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">posee_atributos</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">tipo_item</span><span class="o">.</span><span class="n">tipos_atributo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tipo_atributo</span><span class="p">)</span>
        <span class="n">tipo_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tipo_item&#39;</span><span class="p">:</span><span class="n">tipo_item</span><span class="p">,</span> <span class="s">&#39;tipo_atributo&#39;</span><span class="p">:</span><span class="n">tipo_atributo</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;posee_atributos&#39;</span><span class="p">:</span><span class="n">posee_atributos</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;tipo_item/quitar_tipo_atributo.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Iniciar fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="iniciar_fase_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.iniciar_fase_view">[docs]</a><span class="k">def</span> <span class="nf">iniciar_fase_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para iniciar una fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Iniciar fase.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario iniciar una fase si es que cumple con las siguientes condiciones:</span>
<span class="sd">        </span>
<span class="sd">            - Debe estar en estado Inactivo.</span>
<span class="sd">            - Debe poseer al menos un rol.</span>
<span class="sd">            - Debe poseer al menos un tipo de item.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">inicio_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">roles_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">tipos_item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">inicio_valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">tipos_item</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tipos_item_valido</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">inicio_valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">roles_valido</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">inicio_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">inicio_valido</span><span class="p">:</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;inicio_valido&#39;</span><span class="p">:</span><span class="n">inicio_valido</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;tipos_item_valido&#39;</span><span class="p">:</span><span class="n">tipos_item_valido</span><span class="p">,</span> <span class="s">&#39;roles_valido&#39;</span><span class="p">:</span><span class="n">roles_valido</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/iniciar_fase.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;inicio_valido&#39;</span><span class="p">:</span><span class="n">inicio_valido</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;tipos_item_valido&#39;</span><span class="p">:</span><span class="n">tipos_item_valido</span><span class="p">,</span> <span class="s">&#39;roles_valido&#39;</span><span class="p">:</span><span class="n">roles_valido</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/iniciar_fase.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Finalizar fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="finalizar_fase_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.finalizar_fase_view">[docs]</a><span class="k">def</span> <span class="nf">finalizar_fase_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para finalizar una fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Finalizar fase.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario finalizar una fase si es que cumple con las siguientes condiciones:</span>
<span class="sd">        </span>
<span class="sd">            - Debe estar en estado En curso.</span>
<span class="sd">            - Todos sus items deben estar en estado Bloqueado.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">finalizado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">secuencia_valida</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">num_secuencia</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">num_secuencia</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">num_secuencia</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">fase_anterior</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">num_secuencia</span><span class="o">=</span><span class="n">num_secuencia</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fase_anterior</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">secuencia_valida</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">finalizado_valido</span> <span class="o">=</span> <span class="bp">False</span>
            
    <span class="k">if</span> <span class="n">finalizado_valido</span> <span class="ow">and</span> <span class="n">secuencia_valida</span> <span class="ow">and</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">fase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;finalizado_valido&#39;</span><span class="p">:</span><span class="n">finalizado_valido</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;secuencia_valida&#39;</span><span class="p">:</span><span class="n">secuencia_valida</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/finalizar_fase.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;finalizado_valido&#39;</span><span class="p">:</span><span class="n">finalizado_valido</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;secuencia_valida&#39;</span><span class="p">:</span><span class="n">secuencia_valida</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/finalizar_fase.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar items de fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="items_fase_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.items_fase_view">[docs]</a><span class="k">def</span> <span class="nf">items_fase_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de items por fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Gestionar items de fase.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de desarrollo de los items de la fase seleccionada.</span>
<span class="sd">        Inicialmente, se verifican los permisos del usuario solicitante para restringir (si es necesario) </span>
<span class="sd">        los botones de accion sobre cada item.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">crear_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">modificar_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">eliminar_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">visualizar_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_relaciones</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">aprobar_item</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_versiones</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">permisos</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Crear item&#39;</span><span class="p">:</span>
                <span class="n">crear_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Modificar item&#39;</span><span class="p">:</span>
                <span class="n">modificar_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Eliminar item&#39;</span><span class="p">:</span>
                <span class="n">eliminar_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Visualizar item&#39;</span><span class="p">:</span>
                <span class="n">visualizar_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar relaciones de item&#39;</span><span class="p">:</span>
                <span class="n">gestionar_relaciones</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Aprobar item&#39;</span><span class="p">:</span>
                <span class="n">aprobar_item</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar versiones de item&#39;</span><span class="p">:</span>
                <span class="n">gestionar_versiones</span> <span class="o">=</span> <span class="bp">True</span>
                
            <span class="k">if</span> <span class="n">crear_item</span> <span class="ow">and</span> <span class="n">modificar_item</span> <span class="ow">and</span> <span class="n">eliminar_item</span> <span class="ow">and</span> <span class="n">visualizar_item</span> <span class="ow">and</span> <span class="n">gestionar_relaciones</span> <span class="ow">and</span> <span class="n">aprobar_item</span> <span class="ow">and</span> <span class="n">gestionar_versiones</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">crear_item</span> <span class="ow">and</span> <span class="n">modificar_item</span> <span class="ow">and</span> <span class="n">eliminar_item</span> <span class="ow">and</span> <span class="n">visualizar_item</span> <span class="ow">and</span> <span class="n">gestionar_relaciones</span> <span class="ow">and</span> <span class="n">aprobar_item</span> <span class="ow">and</span> <span class="n">gestionar_versiones</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;valido&#39;</span><span class="p">:</span><span class="n">valido</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">:</span><span class="n">items</span><span class="p">,</span> <span class="s">&#39;crear_item&#39;</span><span class="p">:</span><span class="n">crear_item</span><span class="p">,</span> <span class="s">&#39;modificar_item&#39;</span><span class="p">:</span><span class="n">modificar_item</span><span class="p">,</span> <span class="s">&#39;eliminar_item&#39;</span><span class="p">:</span><span class="n">eliminar_item</span><span class="p">,</span> <span class="s">&#39;visualizar_item&#39;</span><span class="p">:</span><span class="n">visualizar_item</span><span class="p">,</span> <span class="s">&#39;gestionar_relaciones&#39;</span><span class="p">:</span><span class="n">gestionar_relaciones</span><span class="p">,</span> <span class="s">&#39;aprobar_item&#39;</span><span class="p">:</span><span class="n">aprobar_item</span><span class="p">,</span> <span class="s">&#39;gestionar_versiones&#39;</span><span class="p">:</span><span class="n">gestionar_versiones</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/items_fase.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Crear item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="crear_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.crear_item_view">[docs]</a><span class="k">def</span> <span class="nf">crear_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para crear un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Crear item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario crear y agregar un item a la fase previamente seleccionada, para lograr esto, </span>
<span class="sd">        se verifica la validez de cada campo ingresado y luego se crea el item de acuerdo a los campos ingresados y </span>
<span class="sd">        se almacena en la fase. </span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: si la operacion resulto ser de tipo GET o el formulario resulto invalido, devuelve el contexto, </span>
<span class="sd">            generado en la vista, al template correspondiente.</span>
<span class="sd">            - HttpResponseRedirect: si la operacion resulto valida, se redirige al template del listado de items por fase. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">tipos_item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">tipos_item</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">form</span> <span class="o">=</span> <span class="n">CrearItemForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">CrearItemForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">nombre</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;nombre&#39;</span><span class="p">]</span>
                <span class="n">descripcion</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;descripcion&#39;</span><span class="p">]</span>
                <span class="n">complejidad</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;complejidad&#39;</span><span class="p">]</span>
                <span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;costo_monetario&#39;</span><span class="p">]</span>
                <span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;costo_temporal&#39;</span><span class="p">]</span>
                
                <span class="n">id_tipo_item</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tipo_item&#39;</span><span class="p">)</span>
                
                <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_tipo_item</span><span class="p">)</span>
                
                <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">nombre</span><span class="o">=</span><span class="n">nombre</span><span class="p">,</span> <span class="n">descripcion</span><span class="o">=</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">complejidad</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">costo_monetario</span><span class="p">,</span> <span class="n">costo_temporal</span><span class="o">=</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">tipo_item</span><span class="p">)</span>
                <span class="n">tipos_atributo</span> <span class="o">=</span> <span class="n">tipo_item</span><span class="o">.</span><span class="n">tipos_atributo</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">tipo_atributo</span> <span class="ow">in</span> <span class="n">tipos_atributo</span><span class="p">:</span>
                    <span class="n">valor_atributo</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">tipo_item</span><span class="p">,</span> <span class="n">tipo_atributo</span><span class="o">=</span><span class="n">tipo_atributo</span><span class="p">)</span>
                    <span class="n">valor_atributo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">fase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                          <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                          <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                          <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                          <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span> <span class="n">padre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">,</span>
                                                          <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/items/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;tipos_item&#39;</span><span class="p">:</span><span class="n">tipos_item</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;crear_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;tipos_item&#39;</span><span class="p">:</span><span class="n">tipos_item</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/crear_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="k">def</span> <span class="nf">is_number</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    
<span class="k">def</span> <span class="nf">is_date</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Modificar item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<span class="nd">@solicitud_requerida</span><span class="p">(</span><span class="n">accion</span><span class="o">=</span><span class="s">&quot;Modificar item&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="modificar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.modificar_item_view">[docs]</a><span class="k">def</span> <span class="nf">modificar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para modificar un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Modificar item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario modificar un item de la fase previamente seleccionada, para lograr esto, </span>
<span class="sd">        se verifica la validez de cada campo modificado y luego se guarda el item de acuerdo a los campos ingresados.</span>
<span class="sd">    </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:    </span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: si la operacion resulto ser de tipo GET o el formulario resulto invalido, devuelve el contexto, </span>
<span class="sd">            generado en la vista, al template correspondiente.</span>
<span class="sd">            - HttpResponseRedirect: si la operacion resulto valida, se redirige al template de visualizacion del item modificado. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">atributos</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item__id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">form</span> <span class="o">=</span> <span class="n">ModificarItemForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">item_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">ModificarItemForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">nombre</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;nombre&#39;</span><span class="p">]</span>
                <span class="n">descripcion</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;descripcion&#39;</span><span class="p">]</span>
                <span class="n">complejidad</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;complejidad&#39;</span><span class="p">]</span>
                <span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;costo_monetario&#39;</span><span class="p">]</span>
                <span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;costo_temporal&#39;</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atributos</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">tipo_dato</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">valor_numerico</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">valor_numerico</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">tipo_dato</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">is_date</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">valor_fecha</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">valor_fecha</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">tipo_dato</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">valor_texto_grande</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">tipo_dato</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">valor_texto_chico</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">tipo_dato</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">value</span><span class="o">==</span><span class="s">&quot;1&quot;</span><span class="p">:</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">valor_logico</span> <span class="o">=</span> <span class="bp">True</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                <span class="k">elif</span> <span class="n">value</span><span class="o">==</span><span class="s">&quot;0&quot;</span><span class="p">:</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">valor_logico</span> <span class="o">=</span> <span class="bp">False</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atributos</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tipo_atributo</span><span class="o">.</span><span class="n">tipo_dato</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">valor_archivo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">nombre</span> <span class="o">!=</span> <span class="n">nombre</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">descripcion</span> <span class="o">!=</span> <span class="n">descripcion</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">complejidad</span> <span class="o">!=</span> <span class="n">complejidad</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span> <span class="o">!=</span> <span class="n">costo_monetario</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span> <span class="o">!=</span> <span class="n">costo_temporal</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">nombre</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">descripcion</span> <span class="o">=</span> <span class="n">descripcion</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">complejidad</span> <span class="o">=</span> <span class="n">complejidad</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">costo_monetario</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">costo_temporal</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                              <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                              <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                              <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                              <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                              <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                        <span class="n">version_item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/items/item/</span><span class="si">%s</span><span class="s">/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">id_item</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ModificarItemForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;nombre&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
            <span class="s">&#39;descripcion&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span>
            <span class="s">&#39;costo_temporal&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span>
            <span class="s">&#39;costo_monetario&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span>
            <span class="s">&#39;complejidad&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
            <span class="p">})</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;atributos&#39;</span><span class="p">:</span><span class="n">atributos</span><span class="p">,</span> <span class="s">&#39;setting&#39;</span><span class="p">:</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/modificar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Eliminar item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<span class="nd">@solicitud_requerida</span><span class="p">(</span><span class="n">accion</span><span class="o">=</span><span class="s">&quot;Eliminar item&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="eliminar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.eliminar_item_view">[docs]</a><span class="k">def</span> <span class="nf">eliminar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para eliminar un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Eliminar item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario eliminar un item de la fase previamente seleccionada, para lograr esto, </span>
<span class="sd">        se verifica si el item cumple las siguientes condiciones:</span>
<span class="sd">        </span>
<span class="sd">            - El item debe estar en estado En construccion o En revision.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: si la operacion resulto ser de tipo GET o no se cumplieron las condiciones para eliminar, devuelve el contexto, </span>
<span class="sd">            generado en la vista, al template correspondiente.</span>
<span class="sd">            - HttpResponseRedirect: si la operacion resulto valida, se redirige al template del listado de items por fase. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">atributos</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item__id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">relaciones</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">posee_relaciones</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">if</span> <span class="n">relaciones</span><span class="p">:</span>
        <span class="n">posee_relaciones</span> <span class="o">=</span> <span class="bp">True</span>
        
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">item_valido</span> <span class="ow">and</span> <span class="n">posee_relaciones</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">version_eliminada</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="n">version_eliminada</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">version_eliminada</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>
                
            <span class="n">item</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/items/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
    
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;atributos&#39;</span><span class="p">:</span><span class="n">atributos</span><span class="p">,</span> <span class="s">&#39;setting&#39;</span><span class="p">:</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">,</span> <span class="s">&#39;posee_relaciones&#39;</span><span class="p">:</span><span class="n">posee_relaciones</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/eliminar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Visualizar item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="visualizar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.visualizar_item_view">[docs]</a><span class="k">def</span> <span class="nf">visualizar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para visualizar un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Visualizar item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">    </span>
<span class="sd">        Esta vista permite al usuario visualizar todos los campos guardados de un item de la fase previamente seleccionada.</span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">atributos</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item__id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span> <span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;atributos&#39;</span><span class="p">:</span><span class="n">atributos</span><span class="p">,</span> <span class="s">&#39;setting&#39;</span><span class="p">:</span><span class="n">settings</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/visualizar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Aprobar item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="aprobar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.aprobar_item_view">[docs]</a><span class="k">def</span> <span class="nf">aprobar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para aprobar un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Aprobar item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">    </span>
<span class="sd">        Esta vista permite al usuario aprobar un item, es decir, cambiar el estado del item a Aprobado. Para lograr esto, el</span>
<span class="sd">        item debe estar en estado En Construccion o En Revision.</span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">item_valido</span><span class="p">:</span>
        <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                  <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                  <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                  <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                  <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                  <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
            <span class="n">version_item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
        <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/aprobar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="desaprobar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.desaprobar_item_view">[docs]</a><span class="k">def</span> <span class="nf">desaprobar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para desaprobar un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">    </span>
<span class="sd">        Esta vista permite al usuario desaprobar un item, es decir, cambiar el estado del item a En construccion. Para lograr esto, el</span>
<span class="sd">        item debe estar en estado Aprobado o Bloqueado.</span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">item_valido</span><span class="p">:</span>
        <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                  <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                  <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                  <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                  <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                  <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
            <span class="n">version_item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
        <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/desaprobar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="calcular_impacto_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.calcular_impacto_view">[docs]</a><span class="k">def</span> <span class="nf">calcular_impacto_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para calcular impacto. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            - El usuario debe poseer un rol valido para la fase.</span>
<span class="sd">    </span>
<span class="sd">        Esta vista permite al usuario visualizar el calculo de impacto monetario y temporal de un item.</span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">relaciones</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span>
    <span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span>
    <span class="n">posee_hijos</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">relaciones</span><span class="p">:</span>
        <span class="n">posee_hijos</span> <span class="o">=</span> <span class="bp">True</span>
        
    <span class="k">if</span> <span class="n">posee_hijos</span><span class="p">:</span>
        <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>
                            
        <span class="c"># Obtenemos todos los hijos/sucesores del item.</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nuevas_relaciones</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relaciones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relaciones</span><span class="p">:</span>
                <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">nuevas_relaciones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="n">relaciones</span> <span class="o">=</span> <span class="n">nuevas_relaciones</span>
                            
        <span class="c"># Por cada hijo/sucesor se suma su costo monetario y temporal para los calculos a retornar en el template.</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resultados</span><span class="p">:</span>
            <span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">costo_monetario</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">costo_monetario</span>
            <span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">costo_temporal</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">costo_temporal</span>
            
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;posee_hijos&#39;</span><span class="p">:</span><span class="n">posee_hijos</span><span class="p">,</span> <span class="s">&#39;costo_monetario&#39;</span><span class="p">:</span><span class="n">costo_monetario</span><span class="p">,</span> <span class="s">&#39;costo_temporal&#39;</span><span class="p">:</span><span class="n">costo_temporal</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/calculo_impacto.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="revivir_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.revivir_item_view">[docs]</a><span class="k">def</span> <span class="nf">revivir_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para revivir un item eliminado. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Revivir item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario ver un listado de todos los items previamente eliminados de la fase actual. En el template </span>
<span class="sd">        generado se tendra la opcion de revivir los items del listado otorgado.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">items_eliminados</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fase</span><span class="o">=</span><span class="n">fase</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;items_eliminados&quot;</span><span class="p">:</span><span class="n">items_eliminados</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/items_eliminados.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Revivir item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="confirmacion_revivir_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.confirmacion_revivir_item_view">[docs]</a><span class="k">def</span> <span class="nf">confirmacion_revivir_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para revivir un item eliminado. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Revivir item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario revivir un item previamente eliminado. Se encarga de revisar si el item a revivir </span>
<span class="sd">        quiere entrar en una fase en estado Finalizado, en cuyo caso, se abortara la operacion. Ademas, verifica si el</span>
<span class="sd">        item a revivir poseia un padre. Si tenia un padre, la vista se encarga de reasignar el item a la lista de </span>
<span class="sd">        hijos/sucesores del padre item. Si no poseia padre, simplemente queda sin padre; los usuarios estan a cargo de </span>
<span class="sd">        asignarlo a un padre item si se necesitase.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
        <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">posee_padre</span><span class="p">:</span>
        
        <span class="n">existe_padre</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item_padre</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Item</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">existe_padre</span> <span class="o">=</span> <span class="bp">False</span>
            
            <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
                <span class="n">item_revivido</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id_item</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                    <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                    <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                    <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">)</span>
                <span class="n">item_revivido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">tipos_atributo</span> <span class="o">=</span> <span class="n">tipo_item</span><span class="o">.</span><span class="n">tipos_atributo</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">tipo_atributo</span> <span class="ow">in</span> <span class="n">tipos_atributo</span><span class="p">:</span>
                    <span class="n">valor_atributo</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item_revivido</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">tipo_item</span><span class="p">,</span> <span class="n">tipo_atributo</span><span class="o">=</span><span class="n">tipo_atributo</span><span class="p">)</span>
                    <span class="n">valor_atributo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item_revivido&quot;</span><span class="p">:</span><span class="n">item_revivido</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&quot;existe_padre&quot;</span><span class="p">:</span><span class="n">existe_padre</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_revivir_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_revivir_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
            <span class="n">item_revivido</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id_item</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span> <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span>
                                                <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span> <span class="n">padre</span><span class="o">=</span><span class="n">item_padre</span><span class="p">,</span> <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span><span class="p">:</span>
                <span class="n">item_revivido</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item_revivido</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span> <span class="ow">and</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">cain</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">item_revivido</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span>
                <span class="n">item_revivido</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">id</span>
            <span class="k">elif</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span> <span class="ow">and</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">cain</span><span class="p">:</span>
                <span class="n">item_revivido</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">cain</span>
            <span class="n">item_revivido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">tipos_atributo</span> <span class="o">=</span> <span class="n">tipo_item</span><span class="o">.</span><span class="n">tipos_atributo</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tipo_atributo</span> <span class="ow">in</span> <span class="n">tipos_atributo</span><span class="p">:</span>
                <span class="n">valor_atributo</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item_revivido</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">tipo_item</span><span class="p">,</span> <span class="n">tipo_atributo</span><span class="o">=</span><span class="n">tipo_atributo</span><span class="p">)</span>
                <span class="n">valor_atributo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">item_padre</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item_revivido</span><span class="p">)</span>
            <span class="n">item_padre</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item_revivido&quot;</span><span class="p">:</span><span class="n">item_revivido</span><span class="p">,</span> <span class="s">&quot;item_padre&quot;</span><span class="p">:</span><span class="n">item_padre</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;existe_padre&quot;</span><span class="p">:</span><span class="n">existe_padre</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_revivir_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_revivir_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
            <span class="n">item_revivido</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id_item</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">)</span>
            <span class="n">item_revivido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">tipo_item</span> <span class="o">=</span> <span class="n">TipoItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">tipos_atributo</span> <span class="o">=</span> <span class="n">tipo_item</span><span class="o">.</span><span class="n">tipos_atributo</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tipo_atributo</span> <span class="ow">in</span> <span class="n">tipos_atributo</span><span class="p">:</span>
                <span class="n">valor_atributo</span> <span class="o">=</span> <span class="n">ValorAtributo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item_revivido</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">tipo_item</span><span class="p">,</span> <span class="n">tipo_atributo</span><span class="o">=</span><span class="n">tipo_atributo</span><span class="p">)</span>
                <span class="n">valor_atributo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item_revivido&quot;</span><span class="p">:</span><span class="n">item_revivido</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_revivir_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_revivir_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            </div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar relaciones de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="relaciones_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.relaciones_item_view">[docs]</a><span class="k">def</span> <span class="nf">relaciones_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de relaciones por item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Gestionar relaciones de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de las relaciones del item seleccionado.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span> 
    <span class="n">hijos</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;padre&#39;</span><span class="p">:</span><span class="n">padre</span><span class="p">,</span> <span class="s">&#39;hijos&#39;</span><span class="p">:</span><span class="n">hijos</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/relaciones_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="agregar_relacion_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.agregar_relacion_view">[docs]</a><span class="k">def</span> <span class="nf">agregar_relacion_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de items pertenecientes a la fase siguiente o la misma fase. La eleccion de una de las anteriores dependera</span>
<span class="sd">        del tipo de relacion que se quiera agregar (Padre-Hijo o Antecesor-Sucesor). Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador del la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">estado_fase_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_fase_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">if</span> <span class="n">estado_fase_valido</span> <span class="ow">and</span> <span class="n">item_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">eleccion_relacion</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;eleccion_relacion&#39;</span><span class="p">)</span>
            
            <span class="c"># Hijos para el item padre</span>
            <span class="k">if</span> <span class="n">eleccion_relacion</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">existen_items_hijos</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">items_hijos</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">padre</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">:</span>
                    <span class="n">items_hijos</span> <span class="o">=</span> <span class="n">items_hijos</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">:</span>
                    <span class="n">items_hijos</span> <span class="o">=</span> <span class="n">items_hijos</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">items_hijos</span><span class="p">:</span>
                    <span class="n">existen_items_hijos</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;items_hijos&#39;</span><span class="p">:</span><span class="n">items_hijos</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_fase_valido&#39;</span><span class="p">:</span><span class="n">estado_fase_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">,</span> <span class="s">&#39;existen_items_hijos&#39;</span><span class="p">:</span><span class="n">existen_items_hijos</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion_relacion</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            
            <span class="c"># Sucesores para el item antecesor</span>
            <span class="k">elif</span> <span class="n">eleccion_relacion</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">estado_item_valido</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">secuencia_fase_valida</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">estado_item_valido</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="n">cant_secuencias</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> 
                <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">num_secuencia</span> <span class="o">==</span> <span class="n">cant_secuencias</span><span class="p">:</span>
                    <span class="n">secuencia_fase_valida</span> <span class="o">=</span> <span class="bp">False</span>
                
                <span class="k">if</span> <span class="n">secuencia_fase_valida</span> <span class="ow">and</span> <span class="n">estado_item_valido</span><span class="p">:</span>
                    <span class="n">existen_items_sucesores</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">fase_vecina</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">num_secuencia</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fase</span><span class="o">.</span><span class="n">num_secuencia</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">items_sucesores</span> <span class="o">=</span> <span class="n">fase_vecina</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">padre</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">items_sucesores</span><span class="p">:</span>
                        <span class="n">existen_items_sucesores</span> <span class="o">=</span> <span class="bp">True</span>
                    
                    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;fase_vecina&#39;</span><span class="p">:</span><span class="n">fase_vecina</span><span class="p">,</span> <span class="s">&#39;items_sucesores&#39;</span><span class="p">:</span><span class="n">items_sucesores</span><span class="p">,</span> <span class="s">&#39;estado_fase_valido&#39;</span><span class="p">:</span><span class="n">estado_fase_valido</span><span class="p">,</span> <span class="s">&#39;estado_item_valido&#39;</span><span class="p">:</span><span class="n">estado_item_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">,</span> <span class="s">&#39;secuencia_fase_valida&#39;</span><span class="p">:</span><span class="n">secuencia_fase_valida</span><span class="p">,</span> <span class="s">&#39;existen_items_sucesores&#39;</span><span class="p">:</span><span class="n">existen_items_sucesores</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion_relacion</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_fase_valido&#39;</span><span class="p">:</span><span class="n">estado_fase_valido</span><span class="p">,</span> <span class="s">&#39;estado_item_valido&#39;</span><span class="p">:</span><span class="n">estado_item_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">,</span> <span class="s">&#39;secuencia_fase_valida&#39;</span><span class="p">:</span><span class="n">secuencia_fase_valida</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion_relacion</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
                    
            <span class="c"># Padres para el item hijo</span>
            <span class="k">elif</span> <span class="n">eleccion_relacion</span> <span class="o">==</span> <span class="s">&quot;2&quot;</span><span class="p">:</span>
                <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">existen_items_padres</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">items_padres</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                    <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">True</span>
                    
                <span class="k">if</span> <span class="n">items_padres</span><span class="p">:</span>
                    <span class="n">existen_items_padres</span> <span class="o">=</span> <span class="bp">True</span>
                    
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;items_padres&#39;</span><span class="p">:</span><span class="n">items_padres</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_fase_valido&#39;</span><span class="p">:</span><span class="n">estado_fase_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">,</span> <span class="s">&#39;existen_items_padres&#39;</span><span class="p">:</span><span class="n">existen_items_padres</span><span class="p">,</span> <span class="s">&#39;posee_padre&#39;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion_relacion</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            
            <span class="c"># Antecesores para el item sucesor</span>
            <span class="k">elif</span> <span class="n">eleccion_relacion</span> <span class="o">==</span> <span class="s">&quot;3&quot;</span><span class="p">:</span>
                <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">secuencia_fase_valida</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                    <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">True</span>
                     
                <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">num_secuencia</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">secuencia_fase_valida</span> <span class="o">=</span> <span class="bp">False</span>
                    
                <span class="k">if</span> <span class="n">posee_padre</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">secuencia_fase_valida</span><span class="p">:</span>
                    <span class="n">existen_items_antecesores</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">fase_vecina</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">num_secuencia</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fase</span><span class="o">.</span><span class="n">num_secuencia</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">items_antecesores</span> <span class="o">=</span> <span class="n">fase_vecina</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">items_antecesores</span><span class="p">:</span>
                        <span class="n">existen_items_antecesores</span> <span class="o">=</span> <span class="bp">True</span>
                        
                    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;fase_vecina&#39;</span><span class="p">:</span><span class="n">fase_vecina</span><span class="p">,</span> <span class="s">&#39;items_antecesores&#39;</span><span class="p">:</span><span class="n">items_antecesores</span><span class="p">,</span> <span class="s">&#39;estado_fase_valido&#39;</span><span class="p">:</span><span class="n">estado_fase_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">,</span> <span class="s">&#39;secuencia_fase_valida&#39;</span><span class="p">:</span><span class="n">secuencia_fase_valida</span><span class="p">,</span> <span class="s">&#39;existen_items_antecesores&#39;</span><span class="p">:</span><span class="n">existen_items_antecesores</span><span class="p">,</span> <span class="s">&#39;posee_padre&#39;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion_relacion</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_fase_valido&#39;</span><span class="p">:</span><span class="n">estado_fase_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">,</span> <span class="s">&#39;secuencia_fase_valida&#39;</span><span class="p">:</span><span class="n">secuencia_fase_valida</span><span class="p">,</span> <span class="s">&#39;posee_padre&#39;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion_relacion</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_fase_valido&#39;</span><span class="p">:</span><span class="n">estado_fase_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Agregar relacion a item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<span class="nd">@solicitud_requerida</span><span class="p">(</span><span class="n">accion</span><span class="o">=</span><span class="s">&quot;Agregar relacion a item&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="confirmacion_agregar_relacion_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.confirmacion_agregar_relacion_view">[docs]</a><span class="k">def</span> <span class="nf">confirmacion_agregar_relacion_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">,</span> <span class="n">id_relacion</span><span class="p">,</span> <span class="n">eleccion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista de la confirmacion de agregacion de una relacion a un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Agregar relacion a item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">        </span>
<span class="sd">        Esta funcionalidad se encarga de realizar la agregacion de relacion. No posee excepciones, puesto que, los items a seleccionar para</span>
<span class="sd">        la agregacion cumplen con todos los requisitos necesarios para evitar inconsistencias en el grafo de items relacionados.</span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador del la fase.</span>
<span class="sd">            - id_relacion: el identificador del item a relacionar.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span> <span class="ow">or</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
        <span class="n">relacion</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_relacion</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">elif</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;2&quot;</span> <span class="ow">or</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;3&quot;</span> <span class="p">:</span>
        <span class="n">relacion</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_relacion</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">relacion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">relacion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">item_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">relacion</span><span class="o">.</span><span class="n">fase</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">tipo_relacion</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">tipo_relacion</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">relacion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
        <span class="c"># Si el padre del item a relacionar es adan.</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">adan</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
            <span class="c"># Version del item guardada.</span>
            <span class="n">version_relacion</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                          <span class="n">descripcion</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                          <span class="n">costo_temporal</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                          <span class="n">estado</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                          <span class="n">adan</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                          <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                <span class="n">version_relacion</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
            <span class="n">version_relacion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    
            <span class="c"># Verificamos si existen items que son hijos/sucesores del item a relacionar.</span>
            <span class="n">relaciones</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="c"># Si existe al menos uno, se cargaran todos los hijos/sucesores en la lista resultados.</span>
            <span class="k">if</span> <span class="n">relaciones</span><span class="p">:</span>
                <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>
                            
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nuevas_relaciones</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relaciones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relaciones</span><span class="p">:</span>
                        <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">nuevas_relaciones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                    <span class="n">relaciones</span> <span class="o">=</span> <span class="n">nuevas_relaciones</span>
                            
                <span class="c"># Por cada hijo/sucesor se modificaran sus campos de gestion de cosistencia del grafo.</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resultados</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                
                    <span class="n">version_r</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                           <span class="n">descripcion</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                           <span class="n">costo_temporal</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                           <span class="n">estado</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                           <span class="n">adan</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                           <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                        <span class="n">version_r</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">version_r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c"># Fin--&gt; Si el padre del item a relacionar es adan.</span>
        <span class="c"># Si el padre del item a relacionar no es adan.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">adan</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">relacion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
            <span class="c"># Version del item guardada.</span>
            <span class="n">version_relacion</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                          <span class="n">descripcion</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                          <span class="n">costo_temporal</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                          <span class="n">estado</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                          <span class="n">adan</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                          <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                <span class="n">version_relacion</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
            <span class="n">version_relacion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        
            <span class="c"># Verificamos si existen items que son hijos/sucesores del item a relacionar.</span>
            <span class="n">relaciones</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="c"># Si existe al menos uno, se cargaran todos los hijos/sucesores en la lista resultados.</span>
            <span class="k">if</span> <span class="n">relaciones</span><span class="p">:</span>
                <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>
                            
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nuevas_relaciones</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relaciones</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relaciones</span><span class="p">:</span>
                        <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">nuevas_relaciones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                    <span class="n">relaciones</span> <span class="o">=</span> <span class="n">nuevas_relaciones</span>
                            
                <span class="c"># Por cada hijo/sucesor se modificaran sus campos de gestion de cosistencia del grafo.</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resultados</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                
                    <span class="n">version_r</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                           <span class="n">descripcion</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                           <span class="n">costo_temporal</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                           <span class="n">estado</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                           <span class="n">adan</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                           <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                        <span class="n">version_r</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">version_r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c"># Fin--&gt; Si el padre del item a relacionar no es adan.</span>
            
        <span class="n">item</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relacion</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;relacion&#39;</span><span class="p">:</span><span class="n">relacion</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_agregar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Quitar relacion de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<span class="nd">@solicitud_requerida</span><span class="p">(</span><span class="n">accion</span><span class="o">=</span><span class="s">&quot;Quitar relacion de item&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="quitar_relacion_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.quitar_relacion_view">[docs]</a><span class="k">def</span> <span class="nf">quitar_relacion_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">,</span> <span class="n">id_relacion</span><span class="p">,</span> <span class="n">eleccion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para quitar una relacion de un item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Quitar relacion de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">        </span>
<span class="sd">        Esta funcionalidad permite a un usuario romper una relacion entre el padre/antecesor item y un hijo hijo/sucesor. Ademas de esto, </span>
<span class="sd">        todos aquellos items hijos/sucesores del item hijo/sucesor en cuestion pasan a cambiar el valor de su padre raiz por el identificador</span>
<span class="sd">        del item hijo/sucesor en cuestion.</span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador del la fase.</span>
<span class="sd">            - id_relacion: el identificador del item a relacionar.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span> <span class="ow">or</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
        <span class="n">relacion</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_relacion</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">elif</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;2&quot;</span> <span class="ow">or</span> <span class="n">eleccion</span> <span class="o">==</span> <span class="s">&quot;3&quot;</span> <span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
        <span class="n">relacion</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_relacion</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">relacion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">relacion</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">item_valido</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">item_valido</span><span class="p">:</span>
        <span class="n">relacion</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">relacion</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">relacion</span><span class="o">.</span><span class="n">tipo_relacion</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">relacion</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">relacion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">version_relacion</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                      <span class="n">descripcion</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                      <span class="n">costo_temporal</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                      <span class="n">estado</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                      <span class="n">adan</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                      <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">relacion</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
            <span class="n">version_relacion</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
        <span class="n">version_relacion</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="n">relaciones</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relaciones</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">id</span>
            <span class="n">r</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">r</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">version_r</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                   <span class="n">descripcion</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                   <span class="n">costo_temporal</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                   <span class="n">estado</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                   <span class="n">adan</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                   <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                <span class="n">version_r</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
            <span class="n">version_r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">hijos</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nuevas_relaciones</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hijos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hijos</span><span class="p">:</span>
                    <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">nuevas_relaciones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">hijos</span> <span class="o">=</span> <span class="n">nuevas_relaciones</span>
            
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">resultados</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">relacion</span><span class="o">.</span><span class="n">id</span>
                <span class="n">h</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span>
                <span class="n">h</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">h</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">version_h</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                       <span class="n">descripcion</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                       <span class="n">costo_temporal</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                       <span class="n">estado</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                       <span class="n">adan</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                       <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                    <span class="n">version_h</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
                <span class="n">version_h</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;relacion&#39;</span><span class="p">:</span><span class="n">relacion</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;eleccion&#39;</span><span class="p">:</span><span class="n">eleccion</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;item_valido&#39;</span><span class="p">:</span><span class="n">item_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/quitar_relacion.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar versiones de item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="versiones_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.versiones_item_view">[docs]</a><span class="k">def</span> <span class="nf">versiones_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de versiones por item. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Gestionar versiones de item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar las versiones de un item previamente seleccionado. Por cada item en la tabla de </span>
<span class="sd">        versiones, se podra reversionar uno eligido.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">versiones</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;versiones&#39;</span><span class="p">:</span><span class="n">versiones</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/versiones_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Reversionar item&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<span class="nd">@solicitud_requerida</span><span class="p">(</span><span class="n">accion</span><span class="o">=</span><span class="s">&quot;Reversionar item&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="confirmacion_reversionar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.confirmacion_reversionar_item_view">[docs]</a><span class="k">def</span> <span class="nf">confirmacion_reversionar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">,</span> <span class="n">id_reversion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista de la confirmacion de reversionado de un item previamente seleccionado. Para acceder a esta vista se deben cumplir los </span>
<span class="sd">        siguientes requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Reversionar item.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">        </span>
<span class="sd">        Esta funcionalidad se encarga de realizar el reversionado de item. Se verifica si el item a reversionar no provoca inconsistencias en el </span>
<span class="sd">        grafo de relaciones del proyecto.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_fase: el identificador del la fase.</span>
<span class="sd">            - id_reversion: el identificador del item reversionado.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">item_reversion</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_reversion</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">fase_valida</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">posee_hijos</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">fase_valida</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">relaciones</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">posee_hijos</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="c"># Si el estado del item a reemplazar con la reversion no es Aprobado ni Bloqueado, el estado de la fase no es Finalizado y el item a reversionar no posee hijos/sucesores.</span>
    <span class="k">if</span> <span class="n">estado_valido</span> <span class="ow">and</span> <span class="n">fase_valida</span> <span class="ow">and</span> <span class="n">posee_hijos</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="k">if</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
            <span class="n">posee_padre</span> <span class="o">=</span> <span class="bp">True</span>
            
        <span class="c"># Si el item a reversionar posee un padre/antecesor.</span>
        <span class="k">if</span> <span class="n">posee_padre</span><span class="p">:</span>
            <span class="n">existe_padre</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">estado_padre_valido</span> <span class="o">=</span> <span class="bp">True</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">item_padre</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item_reversion</span><span class="o">.</span><span class="n">padre</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">fase</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">fase</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">estado</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">estado_padre_valido</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">except</span> <span class="n">Item</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">existe_padre</span> <span class="o">=</span> <span class="bp">False</span>
            
            <span class="c"># Si el padre (del item a reversionar) existe y ademas posee un estado valido.</span>
            <span class="k">if</span> <span class="n">existe_padre</span> <span class="ow">and</span> <span class="n">estado_padre_valido</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">nombre</span>
                <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">version</span>
                <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">estado</span>
                <span class="n">item</span><span class="o">.</span><span class="n">descripcion</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">descripcion</span>
                <span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">costo_monetario</span>
                <span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">costo_temporal</span>
                <span class="n">item</span><span class="o">.</span><span class="n">complejidad</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">complejidad</span>
                <span class="n">item</span><span class="o">.</span><span class="n">fase</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">fase</span>
                <span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">tipo_item</span>
                
                <span class="c"># Verificamos si el padre y el item a reversionar pertenecen a la misma fase.</span>
                <span class="k">if</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">fase</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span> <span class="o">=</span> <span class="mi">1</span>
                
                <span class="c"># Si el padre del item a reversionar es adan.</span>
                <span class="k">if</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item_padre</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c"># Fin--&gt; Si el padre del item a reversionar es adan.</span>
                <span class="c"># Si el padre del item a reversionar no es adan.</span>
                <span class="k">elif</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">adan</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="n">item_padre</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item_padre</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c"># Fin--&gt; Si el padre del item a reversionar no es adan.</span>
                
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item_reversion&quot;</span><span class="p">:</span><span class="n">item_reversion</span><span class="p">,</span> <span class="s">&quot;item&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&quot;existe_padre&quot;</span><span class="p">:</span><span class="n">existe_padre</span><span class="p">,</span> <span class="s">&quot;estado_padre_valido&quot;</span><span class="p">:</span><span class="n">estado_padre_valido</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&quot;fase_valida&quot;</span><span class="p">:</span><span class="n">fase_valida</span><span class="p">,</span> <span class="s">&#39;posee_hijos&#39;</span><span class="p">:</span><span class="n">posee_hijos</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_reversionar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            <span class="c"># Fin--&gt; Si el padre (del item a reversionar) existe y ademas posee un estado valido.</span>
            <span class="c"># Si el padre (del item a reversionar) no existe o el padre posee un estado no valido.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">nombre</span>
                <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">estado</span>
                <span class="n">item</span><span class="o">.</span><span class="n">descripcion</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">descripcion</span>
                <span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">costo_monetario</span>
                <span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">costo_temporal</span>
                <span class="n">item</span><span class="o">.</span><span class="n">complejidad</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">complejidad</span>
                <span class="n">item</span><span class="o">.</span><span class="n">fase</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">fase</span>
                <span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">tipo_item</span>
                <span class="n">item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">item</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">item</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="c"># Version del item guardada.</span>
                <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                          <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                          <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                          <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                          <span class="n">adan</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">padre</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tipo_relacion</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                                                          <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item_reversion&quot;</span><span class="p">:</span><span class="n">item_reversion</span><span class="p">,</span> <span class="s">&quot;item&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&quot;existe_padre&quot;</span><span class="p">:</span><span class="n">existe_padre</span><span class="p">,</span> <span class="s">&quot;estado_padre_valido&quot;</span><span class="p">:</span><span class="n">estado_padre_valido</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&quot;fase_valida&quot;</span><span class="p">:</span><span class="n">fase_valida</span><span class="p">,</span> <span class="s">&#39;posee_hijos&#39;</span><span class="p">:</span><span class="n">posee_hijos</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_reversionar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            <span class="c"># Fin--&gt; Si el padre (del item a reversionar) no existe o el padre posee un estado no valido.</span>
        <span class="c"># Fin--&gt; Si el item a reversionar posee un padre/antecesor.</span>
        <span class="c"># Si el item a reversionar no posee un padre/antecesor.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">nombre</span>
            <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">version</span>
            <span class="n">item</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">estado</span>
            <span class="n">item</span><span class="o">.</span><span class="n">descripcion</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">descripcion</span>
            <span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">costo_monetario</span>
            <span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">costo_temporal</span>
            <span class="n">item</span><span class="o">.</span><span class="n">complejidad</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">complejidad</span>
            <span class="n">item</span><span class="o">.</span><span class="n">fase</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">fase</span>
            <span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span> <span class="o">=</span> <span class="n">item_reversion</span><span class="o">.</span><span class="n">tipo_item</span>
            <span class="n">item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">item</span><span class="o">.</span><span class="n">adan</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">item</span><span class="o">.</span><span class="n">cain</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item_reversion&quot;</span><span class="p">:</span><span class="n">item_reversion</span><span class="p">,</span> <span class="s">&quot;item&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;posee_padre&quot;</span><span class="p">:</span><span class="n">posee_padre</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&quot;fase_valida&quot;</span><span class="p">:</span><span class="n">fase_valida</span><span class="p">,</span> <span class="s">&#39;posee_hijos&#39;</span><span class="p">:</span><span class="n">posee_hijos</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_reversionar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="c"># Fin--&gt; Si el item a reversionar no posee un padre/antecesor.</span>
    <span class="c"># Fin--&gt; Si el estado del item a reemplazar con la reversion no es Aprobado ni Bloqueado, el estado de la fase no es Finalizado y el item a reversionar no posee hijos/sucesores.</span>
    <span class="c"># Si el estado (del item a reemplazar con la reversion) es Aprobado o Bloqueado, o el estado de la fase es Finalizado, o el item a reversionar posee hijos/sucesores.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;item_reversion&quot;</span><span class="p">:</span><span class="n">item_reversion</span><span class="p">,</span> <span class="s">&quot;item&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;fase&quot;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&quot;proyecto&quot;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&quot;estado_valido&quot;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&quot;fase_valida&quot;</span><span class="p">:</span><span class="n">fase_valida</span><span class="p">,</span> <span class="s">&#39;posee_hijos&#39;</span><span class="p">:</span><span class="n">posee_hijos</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;item/confirmacion_reversionar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="c"># Fin--&gt; Si el estado (del item a reemplazar con la reversion) es Aprobado o Bloqueado, o el estado de la fase es Finalizado, o el item a reversionar posee hijos/sucesores.</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar lineas base de fase&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="lineas_base_fase_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.lineas_base_fase_view">[docs]</a><span class="k">def</span> <span class="nf">lineas_base_fase_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de lineas base por fase. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">                - El usuario debe estar logueado.</span>
<span class="sd">                - El usuario debe poseer el permiso: Gestionar lineas base de fase.</span>
<span class="sd">                - Debe ser miembro del proyecto en cuestion.</span>
<span class="sd">        </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de las lineas base por fase.</span>
<span class="sd">        Inicialmente, se verifican los permisos del usuario solicitante para restringir (si es necesario) </span>
<span class="sd">        los botones de accion sobre cada linea base.</span>
<span class="sd">                </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">                - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">                - id_fase: el identificador de la fase.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">                - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">crear_linea_base</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">cerrar_linea_base</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">visualizar_linea_base</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">gestionar_items</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">permisos</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Crear linea base&#39;</span><span class="p">:</span>
                <span class="n">crear_linea_base</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Cerrar linea base&#39;</span><span class="p">:</span>
                <span class="n">cerrar_linea_base</span><span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Visualizar linea base&#39;</span><span class="p">:</span>
                <span class="n">visualizar_linea_base</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">nombre</span> <span class="o">==</span> <span class="s">&#39;Gestionar items de linea base&#39;</span><span class="p">:</span>
                <span class="n">gestionar_items</span> <span class="o">=</span> <span class="bp">True</span>
                
            <span class="k">if</span> <span class="n">crear_linea_base</span> <span class="ow">and</span> <span class="n">cerrar_linea_base</span> <span class="ow">and</span> <span class="n">visualizar_linea_base</span> <span class="ow">and</span>  <span class="n">gestionar_items</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">crear_linea_base</span> <span class="ow">and</span> <span class="n">cerrar_linea_base</span> <span class="ow">and</span> <span class="n">visualizar_linea_base</span> <span class="ow">and</span>  <span class="n">gestionar_items</span><span class="p">:</span>
                <span class="k">break</span>
                
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">lineas_base</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;valido&#39;</span><span class="p">:</span><span class="n">valido</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;lineas_base&#39;</span><span class="p">:</span><span class="n">lineas_base</span><span class="p">,</span> <span class="s">&#39;crear_linea_base&#39;</span><span class="p">:</span><span class="n">crear_linea_base</span><span class="p">,</span> <span class="s">&#39;cerrar_linea_base&#39;</span><span class="p">:</span><span class="n">cerrar_linea_base</span><span class="p">,</span> <span class="s">&#39;visualizar_linea_base&#39;</span><span class="p">:</span><span class="n">visualizar_linea_base</span><span class="p">,</span>  <span class="s">&#39;gestionar_items&#39;</span><span class="p">:</span><span class="n">gestionar_items</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;fase/lineas_base_fase.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Crear linea base&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="crear_linea_base_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.crear_linea_base_view">[docs]</a><span class="k">def</span> <span class="nf">crear_linea_base_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para crear una linea base. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Crear linea base.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario crear y agregar una linea base a la fase previamente seleccionada, para lograr esto, </span>
<span class="sd">        se verifica la validez de cada campo ingresado y luego se crea la linea base de acuerdo a los campos ingresados y </span>
<span class="sd">        se almacena en la fase. </span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: si la operacion resulto ser de tipo GET o el formulario resulto invalido, devuelve el contexto, </span>
<span class="sd">            generado en la vista, al template correspondiente.</span>
<span class="sd">            - HttpResponseRedirect: si la operacion resulto valida, se redirige al template del listado de lineas base por fase. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">if</span> <span class="n">fase</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">form</span> <span class="o">=</span> <span class="n">CrearLineaBaseForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">CrearLineaBaseForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">nombre</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;nombre&#39;</span><span class="p">]</span>
                <span class="n">descripcion</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;descripcion&#39;</span><span class="p">]</span>
                
                <span class="n">linea_base</span> <span class="o">=</span> <span class="n">LineaBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">nombre</span><span class="o">=</span><span class="n">nombre</span><span class="p">,</span> <span class="n">descripcion</span><span class="o">=</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">num_secuencia</span><span class="o">=</span><span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">linea_base</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">linea_base</span><span class="p">)</span>
                <span class="n">fase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&#39;/desarrollo/fases/lineas_base/fase/</span><span class="si">%s</span><span class="s">/proyecto/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">id_fase</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">))</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/crear_linea_base.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/crear_linea_base.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Visualizar linea base&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="visualizar_linea_base_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.visualizar_linea_base_view">[docs]</a><span class="k">def</span> <span class="nf">visualizar_linea_base_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_linea_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para visualizar una linea base. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Visualizar linea base.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">    </span>
<span class="sd">        Esta vista permite al usuario visualizar todos los campos guardados de una linea base de la fase previamente seleccionada.</span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">    </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_linea_base: el identificador de la linea base.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">linea_base</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_linea_base</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;linea_base&#39;</span><span class="p">:</span> <span class="n">linea_base</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">:</span><span class="n">items</span><span class="p">,</span> <span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/visualizar_linea_base.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Gestionar items de linea base&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="items_linea_base_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.items_linea_base_view">[docs]</a><span class="k">def</span> <span class="nf">items_linea_base_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_linea_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de items por linea base. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Gestionar items de linea base.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar y conocer las opciones de los items de la linea base previamente seleccionada.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_linea_base: identificador de la linea base.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">linea_base__id</span><span class="o">=</span><span class="n">id_linea_base</span><span class="p">)</span>
    <span class="n">linea_base</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_linea_base</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">:</span><span class="n">items</span><span class="p">,</span> <span class="s">&#39;linea_base&#39;</span><span class="p">:</span><span class="n">linea_base</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/items_linea_base.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="linea_base_agregar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.linea_base_agregar_item_view">[docs]</a><span class="k">def</span> <span class="nf">linea_base_agregar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_linea_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista del listado de items de la fase ligados a la linea base. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario listar todos los items de la fase al cual esta ligada la linea base, ademas, el template relacionado concede </span>
<span class="sd">        las opciones para agregar un item seleccionado.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_linea_base: el identificador de la linea base.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">proyecto</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">linea_base</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_linea_base</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">:</span><span class="n">items</span><span class="p">,</span> <span class="s">&#39;linea_base&#39;</span><span class="p">:</span><span class="n">linea_base</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/agregar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Agregar item a linea base&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="linea_base_confirmacion_agregar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.linea_base_confirmacion_agregar_item_view">[docs]</a><span class="k">def</span> <span class="nf">linea_base_confirmacion_agregar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_linea_base</span><span class="p">,</span> <span class="n">id_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista de confirmacion de agregacion de un item a una linea base. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Agregar item a linea base.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario agregar un item seleccionado a la linea base seleccionada previamente. Se verifica si el item a agregar ya </span>
<span class="sd">        pertenece a la linea base, en cuyo caso se cancelara la operacion.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_linea_base: el identificador de la linea base.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">linea_base</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_linea_base</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">valido</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">item</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">valido</span> <span class="o">=</span> <span class="bp">True</span>      
    <span class="k">if</span> <span class="n">valido</span><span class="p">:</span>
        <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">linea_base</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                  <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                  <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                  <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                  <span class="n">linea_base</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">linea_base</span><span class="p">,</span> <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span> 
                                                  <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
            <span class="n">version_item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
        <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;linea_base&#39;</span><span class="p">:</span><span class="n">linea_base</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;valido&#39;</span><span class="p">:</span><span class="n">valido</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/confirmacion_agregar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>  
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Quitar item de linea base&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="linea_base_quitar_item_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.linea_base_quitar_item_view">[docs]</a><span class="k">def</span> <span class="nf">linea_base_quitar_item_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_item</span><span class="p">,</span> <span class="n">id_linea_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para quitar un item de una linea base. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">        </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Quitar item de linea base.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">        </span>
<span class="sd">        Esta vista permite al usuario quitar un item seleccionado de la linea base seleccionada previamente.</span>
<span class="sd">        </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_item: el identificador del item.</span>
<span class="sd">            - id_linea_base: el identificador del linea base.</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">proyecto</span><span class="o">.</span><span class="n">fases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">linea_base</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_linea_base</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_item</span><span class="p">)</span>
    <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="n">linea_base</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">item</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
    <span class="n">version_item</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                              <span class="n">descripcion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                              <span class="n">costo_temporal</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                              <span class="n">estado</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                              <span class="n">linea_base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adan</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                              <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
        <span class="n">version_item</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
    <span class="n">version_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">:</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;linea_base&#39;</span><span class="p">:</span><span class="n">linea_base</span><span class="p">,</span>  <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/quitar_item.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</div>
<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/login/&#39;</span><span class="p">)</span>
<span class="nd">@permiso_requerido</span><span class="p">(</span><span class="n">permiso</span><span class="o">=</span><span class="s">&quot;Cerrar linea base&quot;</span><span class="p">)</span>
<span class="nd">@miembro_proyecto</span><span class="p">()</span>
<span class="nd">@rol_fase_requerido</span><span class="p">()</span>
<div class="viewcode-block" id="cerrar_linea_base_view"><a class="viewcode-back" href="../../moduloDES/views.html#desarrollo.views.cerrar_linea_base_view">[docs]</a><span class="k">def</span> <span class="nf">cerrar_linea_base_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">id_proyecto</span><span class="p">,</span> <span class="n">id_fase</span><span class="p">,</span> <span class="n">id_linea_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        La vista para cerrar una linea base. Para acceder a esta vista se deben cumplir los siguientes</span>
<span class="sd">        requisitos:</span>
<span class="sd">    </span>
<span class="sd">            - El usuario debe estar logueado.</span>
<span class="sd">            - El usuario debe poseer el permiso: Cerrar linea base.</span>
<span class="sd">            - El usuario debe ser miembro del proyecto al cual esta ligada la fase.</span>
<span class="sd">            </span>
<span class="sd">        Esta vista permite al usuario cerrar una linea base si es que cumple con las siguientes condiciones:</span>
<span class="sd">        </span>
<span class="sd">            - Debe estar en estado Abierta.</span>
<span class="sd">            - Todos sus items deben estar en estado Bloqueado.</span>
<span class="sd">            </span>
<span class="sd">        La vista recibe los siguientes parametros:</span>
<span class="sd">        </span>
<span class="sd">            - request: contiene informacion sobre la sesion actual.</span>
<span class="sd">            - id_fase: el identificador de la fase.</span>
<span class="sd">            - id_linea_base: el identificador de la linea base</span>
<span class="sd">            - id_proyecto: el identificador del proyecto.</span>
<span class="sd">            </span>
<span class="sd">        La vista retorna lo siguiente:</span>
<span class="sd">        </span>
<span class="sd">            - render_to_response: devuelve el contexto, generado en la vista, al template correspondiente. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fase</span> <span class="o">=</span> <span class="n">Fase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_fase</span><span class="p">)</span>
    <span class="n">proyecto</span> <span class="o">=</span> <span class="n">Proyecto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_proyecto</span><span class="p">)</span>
    <span class="n">linea_base</span> <span class="o">=</span> <span class="n">fase</span><span class="o">.</span><span class="n">lineas_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_linea_base</span><span class="p">)</span>
    
    <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">estado</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">estado_valido</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">estado_valido</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">linea_base</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">i</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id_item</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">version_i</span> <span class="o">=</span> <span class="n">VersionItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">id_item</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span> 
                                                   <span class="n">descripcion</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">descripcion</span><span class="p">,</span> <span class="n">costo_monetario</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">costo_monetario</span><span class="p">,</span> 
                                                   <span class="n">costo_temporal</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">costo_temporal</span><span class="p">,</span> <span class="n">complejidad</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">complejidad</span><span class="p">,</span>
                                                   <span class="n">estado</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="n">fase</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">fase</span><span class="p">,</span> <span class="n">tipo_item</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">tipo_item</span><span class="p">,</span>
                                                   <span class="n">linea_base</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">linea_base</span><span class="p">,</span> <span class="n">adan</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">adan</span><span class="p">,</span> <span class="n">cain</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">cain</span><span class="p">,</span>
                                                   <span class="n">tipo_relacion</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">tipo_relacion</span><span class="p">,</span> <span class="n">fecha_version</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">padre</span><span class="p">:</span>
                <span class="n">version_i</span><span class="o">.</span><span class="n">padre</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">padre</span><span class="o">.</span><span class="n">id</span>
            <span class="n">version_i</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
        <span class="n">linea_base</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">linea_base</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;linea_base&#39;</span><span class="p">:</span><span class="n">linea_base</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/cerrar_linea_base.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fase&#39;</span><span class="p">:</span><span class="n">fase</span><span class="p">,</span> <span class="s">&#39;estado_valido&#39;</span><span class="p">:</span><span class="n">estado_valido</span><span class="p">,</span> <span class="s">&#39;proyecto&#39;</span><span class="p">:</span><span class="n">proyecto</span><span class="p">,</span> <span class="s">&#39;linea_base&#39;</span><span class="p">:</span><span class="n">linea_base</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;linea_base/cerrar_linea_base.html&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2014, Rodrigo Santos | Gustavo Cabral.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>